<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Threat Risk Assessment — Decentral Park</title>
<style>
  :root {
    --bg: #f9fafb;
    --surface: #ffffff;
    --primary: #0a0a0a;
    --accent: #16a34a;
    --accent-dark: #15803d;
    --accent-light: #166534;
    --info: #f0fdf4;
    --info-border: #86efac;
    --text: #0a0a0a;
    --text-muted: #6b7280;
    --border: #e5e7eb;
    --header-bg: #0a0a0a;
    --header-text: #ffffff;
    --row-alt: #f9fafb;
    --row-hover: #f0fdf4;
    --danger: #dc2626;
    --success: #16a34a;
    --warning: #d97706;
    --tab-active: #16a34a;
    --tab-inactive: #9ca3af;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: ui-sans-serif, system-ui, -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  .app-header {
    background: var(--header-bg);
    color: var(--header-text);
    padding: 28px 32px;
    text-align: center;
  }
  .app-header .brand {
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: #86efac;
    margin-bottom: 8px;
  }
  .app-header h1 {
    font-size: 26px;
    font-weight: 700;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
  }
  .app-header p {
    font-size: 14px;
    opacity: 0.6;
  }

  .tab-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 2px;
    background: #111111;
    padding: 6px 16px 0;
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .tab-btn {
    padding: 10px 18px;
    border: none;
    background: transparent;
    color: rgba(255,255,255,0.45);
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    border-radius: 8px 8px 0 0;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .tab-btn:hover { color: rgba(255,255,255,0.8); background: rgba(255,255,255,0.06); }
  .tab-btn.active {
    background: var(--bg);
    color: var(--accent);
  }
  .tab-btn.result-tab { color: rgba(134,239,172,0.6); }
  .tab-btn.result-tab.active { color: var(--accent); background: var(--bg); }

  .tab-panel { display: none; padding: 24px; max-width: 1100px; margin: 0 auto; }
  .tab-panel.active { display: block; }

  .exercise-card {
    background: var(--surface);
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    overflow: hidden;
    margin-bottom: 24px;
  }

  .exercise-title {
    background: var(--primary);
    color: white;
    padding: 16px 24px;
    font-size: 18px;
    font-weight: 700;
  }

  .exercise-instructions {
    background: var(--info);
    border-left: 4px solid var(--info-border);
    padding: 16px 24px;
    font-size: 14px;
    line-height: 1.65;
    color: var(--text);
  }

  .table-wrap { overflow-x: auto; padding: 0; }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }
  thead th {
    background: #1a1a1a;
    color: #f3f4f6;
    padding: 12px 16px;
    text-align: left;
    font-weight: 600;
    font-size: 13px;
    position: sticky;
    top: 0;
    white-space: nowrap;
  }
  tbody tr { border-bottom: 1px solid var(--border); }
  tbody tr:nth-child(even) { background: var(--row-alt); }
  tbody tr:hover { background: var(--row-hover); }
  td { padding: 4px 8px; vertical-align: top; }

  input[type="text"], textarea {
    width: 100%;
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 8px 10px;
    font-size: 13px;
    font-family: inherit;
    transition: border-color 0.2s;
    background: transparent;
  }
  input[type="text"]:focus, textarea:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(22,163,74,0.15);
  }
  textarea { resize: vertical; min-height: 36px; }

  select {
    width: 100%;
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 8px 10px;
    font-size: 13px;
    font-family: inherit;
    background: white;
    cursor: pointer;
  }
  select:focus { outline: none; border-color: var(--accent); }

  input[type="number"] {
    width: 80px;
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 8px 10px;
    font-size: 13px;
    font-family: inherit;
    text-align: center;
  }
  input[type="number"]:focus { outline: none; border-color: var(--accent); }

  .row-num {
    color: var(--text-muted);
    font-size: 12px;
    text-align: center;
    min-width: 30px;
  }

  .auto-cell {
    padding: 8px 10px;
    font-size: 13px;
    color: var(--text);
    min-height: 36px;
  }
  .auto-cell.empty { color: var(--text-muted); font-style: italic; }

  .priority-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 700;
    text-align: center;
    min-width: 28px;
  }
  .priority-high { background: #fef2f2; color: #dc2626; }
  .priority-med { background: #fffbeb; color: #d97706; }
  .priority-low { background: #f0fdf4; color: #16a34a; }

  .nav-row {
    display: flex;
    justify-content: space-between;
    margin-top: 20px;
  }
  .nav-btn {
    padding: 10px 24px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }
  .nav-btn.prev { background: var(--border); color: var(--text); }
  .nav-btn.prev:hover { background: #d1d5db; }
  .nav-btn.next { background: var(--accent); color: white; }
  .nav-btn.next:hover { background: var(--accent-dark); }

  .score-cell { font-weight: 700; font-size: 14px; }

  .add-row-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    margin: 12px 16px;
    border: 1px dashed var(--border);
    border-radius: 8px;
    background: transparent;
    color: var(--text-muted);
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .add-row-btn:hover { border-color: var(--accent); color: var(--accent-dark); }

  .intro-content {
    padding: 32px;
    line-height: 1.8;
    font-size: 15px;
  }
  .intro-content h2 { margin: 20px 0 10px; color: var(--primary); font-size: 18px; }
  .intro-content ol { padding-left: 24px; }
  .intro-content li { margin: 6px 0; }
  .intro-content .start-btn {
    display: inline-block;
    margin-top: 24px;
    padding: 14px 36px;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
  }
  .intro-content .start-btn:hover { background: var(--accent-dark); transform: translateY(-1px); }

  .toolbar {
    display: flex;
    gap: 10px;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    flex-wrap: wrap;
  }
  .toolbar button {
    padding: 6px 14px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: white;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .toolbar button:hover { border-color: var(--accent); color: var(--accent); }

  .results-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    padding: 20px 0;
  }
  .summary-card {
    background: var(--surface);
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }
  .summary-card .num { font-size: 32px; font-weight: 800; color: var(--primary); }
  .summary-card .label { font-size: 13px; color: var(--text-muted); margin-top: 4px; }

  /* ===== MOBILE: card layout for data rows ===== */
  .mobile-card { display: none; }

  @media (max-width: 768px) {
    .app-header { padding: 20px 16px; }
    .app-header h1 { font-size: 20px; }
    .app-header p { font-size: 12px; }

    .tab-bar {
      flex-wrap: nowrap;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      padding: 6px 8px 0;
      gap: 1px;
    }
    .tab-bar::-webkit-scrollbar { display: none; }
    .tab-btn {
      padding: 8px 12px;
      font-size: 11px;
      flex-shrink: 0;
    }

    .tab-panel { padding: 10px; }

    .exercise-title { font-size: 16px; padding: 14px 16px; }
    .exercise-instructions { padding: 12px 16px; font-size: 13px; }
    .intro-content { padding: 20px 16px; font-size: 14px; }
    .intro-content h2 { font-size: 16px; }

    /* Hide desktop tables, show mobile cards */
    .table-wrap { display: none; }
    .mobile-card { display: block; }

    .m-card {
      border-bottom: 1px solid var(--border);
      padding: 14px 16px;
    }
    .m-card:nth-child(even) { background: var(--row-alt); }
    .m-card-num {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 6px;
      font-weight: 600;
    }
    .m-card-field {
      margin-bottom: 10px;
    }
    .m-card-field:last-child { margin-bottom: 0; }
    .m-card-label {
      font-size: 11px;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
    .m-card-value {
      font-size: 14px;
      color: var(--text);
    }
    .m-card input[type="text"],
    .m-card textarea {
      width: 100%;
      font-size: 16px;
      padding: 10px 12px;
    }
    .m-card select {
      width: 100%;
      font-size: 16px;
      padding: 10px 12px;
    }
    .m-card input[type="number"] {
      width: 100%;
      font-size: 16px;
      padding: 10px 12px;
      text-align: left;
    }
    .m-card-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .m-card-row .m-card-field { flex: 1; min-width: 80px; }
    .m-card .auto-cell {
      padding: 0;
      font-size: 14px;
    }
    .m-card .priority-badge { font-size: 13px; }

    .m-empty {
      padding: 24px 16px;
      text-align: center;
      color: var(--text-muted);
      font-size: 14px;
    }

    .nav-row { padding: 0 16px 16px !important; gap: 10px; }
    .nav-btn { padding: 12px 20px; font-size: 14px; flex-shrink: 0; }

    .add-row-btn {
      display: flex;
      justify-content: center;
      margin: 12px 16px;
      padding: 12px;
      font-size: 14px;
    }

    .results-summary {
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      padding: 14px 16px 0 !important;
    }
    .summary-card { padding: 14px; }
    .summary-card .num { font-size: 26px; }
    .summary-card .label { font-size: 12px; }

    .toolbar { justify-content: center; gap: 8px; }
    .toolbar button { padding: 10px 16px !important; font-size: 13px !important; flex: 1; min-width: 0; }
  }

  @media (max-width: 380px) {
    .tab-btn { padding: 7px 9px; font-size: 10px; }
    .results-summary { grid-template-columns: 1fr 1fr; }
    .app-header h1 { font-size: 17px; }
  }
</style>
</head>
<body>

<div class="app-header">
  <div class="brand">Decentral Park</div>
  <h1>Threat Risk Assessment</h1>
  <p>Individual Digital Asset Threat Modeling Worksheet</p>
</div>

<div class="tab-bar" id="tabBar">
  <button class="tab-btn active" data-tab="intro">Overview</button>
  <button class="tab-btn" data-tab="step-a">A: Assets</button>
  <button class="tab-btn" data-tab="step-b">B: Threat Actors</button>
  <button class="tab-btn" data-tab="step-c">C: Risk Rating</button>
  <button class="tab-btn" data-tab="step-d">D: Vulnerability</button>
  <button class="tab-btn result-tab" data-tab="threat-results">Threat Results</button>
  <button class="tab-btn" data-tab="step-e">E: Fix Ease</button>
  <button class="tab-btn" data-tab="step-f">F: Replace Ease</button>
  <button class="tab-btn" data-tab="step-g">G: Remove Ease</button>
  <button class="tab-btn result-tab" data-tab="mitigation-results">Mitigation Results</button>
</div>

<!-- INTRODUCTION -->
<div class="tab-panel active" id="panel-intro">
  <div class="exercise-card">
    <div class="exercise-title">Getting Started</div>
    <div class="intro-content">
      <p>This interactive tool guides you through a structured threat modeling process for your digital assets. By completing each step, you'll identify, prioritize, and plan mitigations for risks to your digital life.</p>

      <h2>How It Works</h2>
      <ol>
        <li><strong>Step A — Identify Assets:</strong> List all digital assets you want to protect (accounts, devices, data, etc.).</li>
        <li><strong>Step B — Identify Threat Actors:</strong> Think about who might want to compromise your assets and why.</li>
        <li><strong>Step C — Rate Risk:</strong> For each asset, rate how damaging it would be if compromised.</li>
        <li><strong>Step D — Rate Vulnerability:</strong> For each asset, rate how exposed or vulnerable it currently is.</li>
        <li><strong>Threat Results:</strong> An auto-calculated priority score combining risk and vulnerability.</li>
        <li><strong>Step E — Ease of Fixing:</strong> Rate how easy it is to fix/harden each asset (1 = very hard, 10 = very easy).</li>
        <li><strong>Step F — Ease of Replacing:</strong> Rate how easy it is to replace each asset if compromised.</li>
        <li><strong>Step G — Ease of Removing:</strong> Rate how easy it is to remove an unnecessary asset entirely.</li>
        <li><strong>Mitigation Results:</strong> A final summary combining all scores to help you decide the best strategy — fix, replace, or remove.</li>
      </ol>

      <p>Data is saved automatically in your browser. Nothing is sent to any server.</p>

      <button class="start-btn" onclick="switchTab('step-a')">Begin Assessment &rarr;</button>
    </div>
  </div>
</div>

<!-- STEP A: ASSETS -->
<div class="tab-panel" id="panel-step-a">
  <div class="exercise-card">
    <div class="exercise-title">Step A: Identify Your Digital Assets</div>
    <div class="exercise-instructions">
      List every digital asset you want to protect. Think broadly: email accounts, social media profiles, cloud storage, devices, financial accounts, medical portals, messaging apps, password managers, cryptocurrency wallets, domain names, and more. Add a brief description of each.
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th style="width:40px">#</th>
            <th style="width:35%">Asset Name</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody id="table-a"></tbody>
      </table>
    </div>
    <div class="mobile-card" id="mobile-a"></div>
    <button class="add-row-btn" onclick="addAssetRow()">+ Add Asset</button>
    <div class="nav-row" style="padding:0 16px 16px">
      <span></span>
      <button class="nav-btn next" onclick="switchTab('step-b')">Next: Threat Actors &rarr;</button>
    </div>
  </div>
</div>

<!-- STEP B: THREAT ACTORS -->
<div class="tab-panel" id="panel-step-b">
  <div class="exercise-card">
    <div class="exercise-title">Step B: Identify Threat Actors</div>
    <div class="exercise-instructions">
      Who might want to compromise your digital assets? Consider: hackers, scammers, stalkers, corporate espionage, nation-states, disgruntled employees, abusive partners, data brokers, or even accidental exposure. Describe their likely motivation and capabilities.
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th style="width:40px">#</th>
            <th style="width:35%">Threat Actor</th>
            <th>Description / Motivation</th>
          </tr>
        </thead>
        <tbody id="table-b"></tbody>
      </table>
    </div>
    <div class="mobile-card" id="mobile-b"></div>
    <button class="add-row-btn" onclick="addThreatRow()">+ Add Threat Actor</button>
    <div class="nav-row" style="padding:0 16px 16px">
      <button class="nav-btn prev" onclick="switchTab('step-a')">&larr; Previous</button>
      <button class="nav-btn next" onclick="switchTab('step-c')">Next: Risk Rating &rarr;</button>
    </div>
  </div>
</div>

<!-- STEP C: RISK RATING -->
<div class="tab-panel" id="panel-step-c">
  <div class="exercise-card">
    <div class="exercise-title">Step C: Rate the Risk of Each Asset</div>
    <div class="exercise-instructions">
      For each asset you listed in Step A, rate how risky it would be if that asset were compromised or lost. Consider the impact on your privacy, finances, safety, and reputation. Add notes explaining your reasoning.
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th style="width:40px">#</th>
            <th style="width:25%">Asset Name</th>
            <th style="width:180px">Risk Rating</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody id="table-c"></tbody>
      </table>
    </div>
    <div class="mobile-card" id="mobile-c"></div>
    <div class="nav-row" style="padding:12px 16px 16px">
      <button class="nav-btn prev" onclick="switchTab('step-b')">&larr; Previous</button>
      <button class="nav-btn next" onclick="switchTab('step-d')">Next: Vulnerability &rarr;</button>
    </div>
  </div>
</div>

<!-- STEP D: VULNERABILITY -->
<div class="tab-panel" id="panel-step-d">
  <div class="exercise-card">
    <div class="exercise-title">Step D: Rate the Vulnerability of Each Asset</div>
    <div class="exercise-instructions">
      For each asset, rate how vulnerable or exposed it currently is to attack. Consider: Is the password strong and unique? Is two-factor authentication enabled? Is the software up to date? Is data encrypted? Could someone access it easily?
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th style="width:40px">#</th>
            <th style="width:25%">Asset Name</th>
            <th style="width:200px">Vulnerability Rating</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody id="table-d"></tbody>
      </table>
    </div>
    <div class="mobile-card" id="mobile-d"></div>
    <div class="nav-row" style="padding:12px 16px 16px">
      <button class="nav-btn prev" onclick="switchTab('step-c')">&larr; Previous</button>
      <button class="nav-btn next" onclick="switchTab('threat-results')">Next: Threat Results &rarr;</button>
    </div>
  </div>
</div>

<!-- THREAT RESULTS -->
<div class="tab-panel" id="panel-threat-results">
  <div class="exercise-card">
    <div class="exercise-title">Threat Assessment Results</div>
    <div class="exercise-instructions">
      This page auto-calculates a priority score for each asset based on your risk and vulnerability ratings from Steps C and D. Higher scores indicate assets that need the most urgent attention. Use the Notes column (1–10 scale) to add your own priority override if desired.
    </div>
    <div id="threat-summary" class="results-summary" style="padding:20px 16px 0"></div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th style="width:40px">#</th>
            <th style="width:25%">Asset Name</th>
            <th style="width:100px">Priority Score</th>
            <th>Notes (1–10)</th>
          </tr>
        </thead>
        <tbody id="table-threat"></tbody>
      </table>
    </div>
    <div class="mobile-card" id="mobile-threat"></div>
    <div class="nav-row" style="padding:12px 16px 16px">
      <button class="nav-btn prev" onclick="switchTab('step-d')">&larr; Previous</button>
      <button class="nav-btn next" onclick="switchTab('step-e')">Next: Fix Ease &rarr;</button>
    </div>
  </div>
</div>

<!-- STEP E: FIX EASE -->
<div class="tab-panel" id="panel-step-e">
  <div class="exercise-card">
    <div class="exercise-title">Step E: Rate Ease of Fixing</div>
    <div class="exercise-instructions">
      For each asset, rate how easy it would be to fix or harden it against threats. Fixing means improving security without replacing the asset: enabling two-factor auth, changing passwords, encrypting data, updating software, adjusting privacy settings, reducing stored sensitive data, etc. Rate on a 1–10 scale where 10 = very easy to fix and 1 = very difficult.
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th style="width:40px">#</th>
            <th style="width:25%">Asset Name</th>
            <th style="width:100px">Priority</th>
            <th style="width:140px">Ease of Fixing (1–10)</th>
          </tr>
        </thead>
        <tbody id="table-e"></tbody>
      </table>
    </div>
    <div class="mobile-card" id="mobile-e"></div>
    <div class="nav-row" style="padding:12px 16px 16px">
      <button class="nav-btn prev" onclick="switchTab('threat-results')">&larr; Previous</button>
      <button class="nav-btn next" onclick="switchTab('step-f')">Next: Replace Ease &rarr;</button>
    </div>
  </div>
</div>

<!-- STEP F: REPLACE EASE -->
<div class="tab-panel" id="panel-step-f">
  <div class="exercise-card">
    <div class="exercise-title">Step F: Rate Ease of Replacing</div>
    <div class="exercise-instructions">
      For each asset, rate how easy it would be to replace it entirely with a more secure alternative. For example: switching email providers, moving to encrypted messaging, using a different cloud service, or getting a new device. Rate 1–10 where 10 = very easy to replace, 1 = very difficult.
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th style="width:40px">#</th>
            <th style="width:22%">Asset Name</th>
            <th style="width:80px">Priority</th>
            <th style="width:60px">Fix</th>
            <th style="width:160px">Ease of Replacing (1–10)</th>
          </tr>
        </thead>
        <tbody id="table-f"></tbody>
      </table>
    </div>
    <div class="mobile-card" id="mobile-f"></div>
    <div class="nav-row" style="padding:12px 16px 16px">
      <button class="nav-btn prev" onclick="switchTab('step-e')">&larr; Previous</button>
      <button class="nav-btn next" onclick="switchTab('step-g')">Next: Remove Ease &rarr;</button>
    </div>
  </div>
</div>

<!-- STEP G: REMOVE EASE -->
<div class="tab-panel" id="panel-step-g">
  <div class="exercise-card">
    <div class="exercise-title">Step G: Rate Ease of Removing</div>
    <div class="exercise-instructions">
      For each asset, rate how easy it would be to remove or decommission it entirely. Sometimes the best mitigation is to eliminate unnecessary digital assets altogether — delete unused accounts, remove apps you don't need, stop using insecure services. Rate 1–10 where 10 = very easy to remove, 1 = very difficult or impossible.
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th style="width:40px">#</th>
            <th style="width:20%">Asset Name</th>
            <th style="width:80px">Priority</th>
            <th style="width:50px">Fix</th>
            <th style="width:70px">Replace</th>
            <th style="width:160px">Ease of Removing (1–10)</th>
          </tr>
        </thead>
        <tbody id="table-g"></tbody>
      </table>
    </div>
    <div class="mobile-card" id="mobile-g"></div>
    <div class="nav-row" style="padding:12px 16px 16px">
      <button class="nav-btn prev" onclick="switchTab('step-f')">&larr; Previous</button>
      <button class="nav-btn next" onclick="switchTab('mitigation-results')">View Mitigation Results &rarr;</button>
    </div>
  </div>
</div>

<!-- MITIGATION RESULTS -->
<div class="tab-panel" id="panel-mitigation-results">
  <div class="exercise-card">
    <div class="exercise-title">Mitigation Strategy Results</div>
    <div class="exercise-instructions">
      This final view brings together all your assessments. For each asset, compare the ease of fixing, replacing, and removing. The recommended strategy is usually the option with the highest ease score — the least disruptive path to reducing risk. Use the Notes column to record your chosen action plan.
    </div>
    <div id="mitigation-summary" class="results-summary" style="padding:20px 16px 0"></div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th style="width:40px">#</th>
            <th style="width:18%">Asset Name</th>
            <th style="width:80px">Priority</th>
            <th style="width:50px">Fix</th>
            <th style="width:70px">Replace</th>
            <th style="width:70px">Remove</th>
            <th>Notes / Action Plan</th>
          </tr>
        </thead>
        <tbody id="table-mitigation"></tbody>
      </table>
    </div>
    <div class="mobile-card" id="mobile-mitigation"></div>
    <div class="toolbar" style="border-top:1px solid var(--border); border-bottom:none; justify-content:center; padding:16px;">
      <button onclick="exportCSV()" style="padding:10px 24px; font-size:14px;">Export as CSV</button>
      <button onclick="printResults()" style="padding:10px 24px; font-size:14px;">Print Results</button>
      <button onclick="clearAll()" style="padding:10px 24px; font-size:14px; color:var(--danger);">Reset All Data</button>
    </div>
    <div class="nav-row" style="padding:0 16px 16px">
      <button class="nav-btn prev" onclick="switchTab('step-g')">&larr; Previous</button>
      <span></span>
    </div>
  </div>
</div>

<script>
// ========== STATE ==========
const STORAGE_KEY = 'threat_risk_tool_data';
const DEFAULT_ROW_COUNT = 15;

let state = loadState();

function defaultState() {
  return {
    assets: Array.from({length: DEFAULT_ROW_COUNT}, () => ({name: '', desc: ''})),
    threats: Array.from({length: 8}, () => ({name: '', desc: ''})),
    riskRatings: {},
    vulnRatings: {},
    threatNotes: {},
    fixScores: {},
    replaceScores: {},
    removeScores: {},
    mitigationNotes: {}
  };
}

function loadState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) return Object.assign(defaultState(), JSON.parse(raw));
  } catch(e) {}
  return defaultState();
}

function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

// ========== UTILS ==========
function esc(s) {
  if (!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function getFilledAssets() {
  return state.assets.map((a, i) => ({...a, idx: i})).filter(a => a.name.trim() !== '');
}

// ========== TABS ==========
function switchTab(id) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  const tabBtn = document.querySelector(`[data-tab="${id}"]`);
  tabBtn.classList.add('active');
  tabBtn.scrollIntoView({behavior:'smooth', block:'nearest', inline:'center'});
  document.getElementById(`panel-${id}`).classList.add('active');
  renderAll();
  window.scrollTo({top: 0});
}

document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => switchTab(btn.dataset.tab));
});

// ========== SCORING ==========
function riskScore(r) { return r==='Very Risky'?3:r==='Risky'?2:r==='Moderately Risky'?1:0; }
function vulnScore(v) { return v==='Very Vulnerable'?3:v==='Vulnerable'?2:v==='Moderately Vulnerable'?2:0; }

function calcPriority(i) {
  const total = riskScore(state.riskRatings[i]?.rating||'') + vulnScore(state.vulnRatings[i]?.rating||'');
  return total > 0 ? total : null;
}

function priorityBadge(score) {
  if (score === null || score === undefined) return '<span class="auto-cell empty">\u2014</span>';
  const cls = score >= 5 ? 'priority-high' : score >= 3 ? 'priority-med' : 'priority-low';
  return `<span class="priority-badge ${cls}">${score}</span>`;
}

function emptyMsg(text) {
  return `<div class="m-empty">${text}</div>`;
}

// ========== BIND HELPERS ==========
function bindInputs(container, handler) {
  container.querySelectorAll('input').forEach(inp => inp.addEventListener('input', handler));
}
function bindSelects(container, handler) {
  container.querySelectorAll('select').forEach(sel => sel.addEventListener('change', handler));
}
function bindNumbers(container, handler) {
  container.querySelectorAll('input[type="number"]').forEach(inp => inp.addEventListener('input', handler));
}

// ========== RENDER: STEP A ==========
function renderTableA() {
  const tbody = document.getElementById('table-a');
  const mob = document.getElementById('mobile-a');

  tbody.innerHTML = state.assets.map((a, i) => `
    <tr>
      <td class="row-num">${i+1}</td>
      <td><input type="text" value="${esc(a.name)}" data-i="${i}" data-field="name" placeholder="e.g., Gmail account"></td>
      <td><input type="text" value="${esc(a.desc)}" data-i="${i}" data-field="desc" placeholder="Primary email for personal and work"></td>
    </tr>`).join('');

  mob.innerHTML = state.assets.map((a, i) => `
    <div class="m-card">
      <div class="m-card-num">Asset ${i+1}</div>
      <div class="m-card-field">
        <div class="m-card-label">Name</div>
        <input type="text" value="${esc(a.name)}" data-i="${i}" data-field="name" placeholder="e.g., Gmail account">
      </div>
      <div class="m-card-field">
        <div class="m-card-label">Description</div>
        <input type="text" value="${esc(a.desc)}" data-i="${i}" data-field="desc" placeholder="Primary email for personal and work">
      </div>
    </div>`).join('');

  const handler = e => {
    state.assets[+e.target.dataset.i][e.target.dataset.field] = e.target.value;
    saveState();
  };
  bindInputs(tbody, handler);
  bindInputs(mob, handler);
}

// ========== RENDER: STEP B ==========
function renderTableB() {
  const tbody = document.getElementById('table-b');
  const mob = document.getElementById('mobile-b');

  tbody.innerHTML = state.threats.map((t, i) => `
    <tr>
      <td class="row-num">${i+1}</td>
      <td><input type="text" value="${esc(t.name)}" data-i="${i}" data-field="name" placeholder="e.g., Phishing scammer"></td>
      <td><input type="text" value="${esc(t.desc)}" data-i="${i}" data-field="desc" placeholder="Sends fake login pages via email"></td>
    </tr>`).join('');

  mob.innerHTML = state.threats.map((t, i) => `
    <div class="m-card">
      <div class="m-card-num">Actor ${i+1}</div>
      <div class="m-card-field">
        <div class="m-card-label">Threat Actor</div>
        <input type="text" value="${esc(t.name)}" data-i="${i}" data-field="name" placeholder="e.g., Phishing scammer">
      </div>
      <div class="m-card-field">
        <div class="m-card-label">Description / Motivation</div>
        <input type="text" value="${esc(t.desc)}" data-i="${i}" data-field="desc" placeholder="Sends fake login pages via email">
      </div>
    </div>`).join('');

  const handler = e => {
    state.threats[+e.target.dataset.i][e.target.dataset.field] = e.target.value;
    saveState();
  };
  bindInputs(tbody, handler);
  bindInputs(mob, handler);
}

// ========== RENDER: STEP C ==========
function renderTableC() {
  const tbody = document.getElementById('table-c');
  const mob = document.getElementById('mobile-c');
  const filled = getFilledAssets();
  const none = 'No assets listed yet. Go to Step A to add assets.';
  if (!filled.length) {
    tbody.innerHTML = `<tr><td colspan="4" style="padding:24px;text-align:center;color:var(--text-muted)">${none}</td></tr>`;
    mob.innerHTML = emptyMsg(none);
    return;
  }
  const opts = (cur) => ['Very Risky','Risky','Moderately Risky'].map(v =>
    `<option value="${v}" ${cur===v?'selected':''}>${v}</option>`).join('');

  tbody.innerHTML = filled.map(a => {
    const r = state.riskRatings[a.idx] || {};
    return `<tr>
      <td class="row-num">${a.idx+1}</td>
      <td class="auto-cell">${esc(a.name)}</td>
      <td><select data-i="${a.idx}"><option value="">\u2014 Select \u2014</option>${opts(r.rating)}</select></td>
      <td><input type="text" value="${esc(r.notes||'')}" data-i="${a.idx}" placeholder="Why this rating?"></td>
    </tr>`;
  }).join('');

  mob.innerHTML = filled.map(a => {
    const r = state.riskRatings[a.idx] || {};
    return `<div class="m-card">
      <div class="m-card-num">${esc(a.name)}</div>
      <div class="m-card-field">
        <div class="m-card-label">Risk Rating</div>
        <select data-i="${a.idx}"><option value="">\u2014 Select \u2014</option>${opts(r.rating)}</select>
      </div>
      <div class="m-card-field">
        <div class="m-card-label">Notes</div>
        <input type="text" value="${esc(r.notes||'')}" data-i="${a.idx}" placeholder="Why this rating?">
      </div>
    </div>`;
  }).join('');

  const selHandler = e => {
    const i = e.target.dataset.i;
    if (!state.riskRatings[i]) state.riskRatings[i] = {};
    state.riskRatings[i].rating = e.target.value;
    saveState();
  };
  const inpHandler = e => {
    const i = e.target.dataset.i;
    if (!state.riskRatings[i]) state.riskRatings[i] = {};
    state.riskRatings[i].notes = e.target.value;
    saveState();
  };
  [tbody, mob].forEach(el => { bindSelects(el, selHandler); bindInputs(el, inpHandler); });
}

// ========== RENDER: STEP D ==========
function renderTableD() {
  const tbody = document.getElementById('table-d');
  const mob = document.getElementById('mobile-d');
  const filled = getFilledAssets();
  const none = 'No assets listed yet. Go to Step A to add assets.';
  if (!filled.length) {
    tbody.innerHTML = `<tr><td colspan="4" style="padding:24px;text-align:center;color:var(--text-muted)">${none}</td></tr>`;
    mob.innerHTML = emptyMsg(none);
    return;
  }
  const opts = (cur) => ['Very Vulnerable','Vulnerable','Moderately Vulnerable'].map(v =>
    `<option value="${v}" ${cur===v?'selected':''}>${v}</option>`).join('');

  tbody.innerHTML = filled.map(a => {
    const v = state.vulnRatings[a.idx] || {};
    return `<tr>
      <td class="row-num">${a.idx+1}</td>
      <td class="auto-cell">${esc(a.name)}</td>
      <td><select data-i="${a.idx}"><option value="">\u2014 Select \u2014</option>${opts(v.rating)}</select></td>
      <td><input type="text" value="${esc(v.notes||'')}" data-i="${a.idx}" placeholder="What makes it vulnerable?"></td>
    </tr>`;
  }).join('');

  mob.innerHTML = filled.map(a => {
    const v = state.vulnRatings[a.idx] || {};
    return `<div class="m-card">
      <div class="m-card-num">${esc(a.name)}</div>
      <div class="m-card-field">
        <div class="m-card-label">Vulnerability Rating</div>
        <select data-i="${a.idx}"><option value="">\u2014 Select \u2014</option>${opts(v.rating)}</select>
      </div>
      <div class="m-card-field">
        <div class="m-card-label">Notes</div>
        <input type="text" value="${esc(v.notes||'')}" data-i="${a.idx}" placeholder="What makes it vulnerable?">
      </div>
    </div>`;
  }).join('');

  const selHandler = e => {
    const i = e.target.dataset.i;
    if (!state.vulnRatings[i]) state.vulnRatings[i] = {};
    state.vulnRatings[i].rating = e.target.value;
    saveState();
  };
  const inpHandler = e => {
    const i = e.target.dataset.i;
    if (!state.vulnRatings[i]) state.vulnRatings[i] = {};
    state.vulnRatings[i].notes = e.target.value;
    saveState();
  };
  [tbody, mob].forEach(el => { bindSelects(el, selHandler); bindInputs(el, inpHandler); });
}

// ========== RENDER: THREAT RESULTS ==========
function renderThreatResults() {
  const tbody = document.getElementById('table-threat');
  const mob = document.getElementById('mobile-threat');
  const filled = getFilledAssets();
  const sumEl = document.getElementById('threat-summary');

  if (!filled.length) {
    tbody.innerHTML = '<tr><td colspan="4" style="padding:24px;text-align:center;color:var(--text-muted)">No assets to score yet.</td></tr>';
    mob.innerHTML = emptyMsg('No assets to score yet.');
    sumEl.innerHTML = '';
    return;
  }

  const scores = filled.map(a => ({...a, priority: calcPriority(a.idx)})).filter(a => a.priority !== null);
  const highCount = scores.filter(s => s.priority >= 5).length;
  const medCount = scores.filter(s => s.priority >= 3 && s.priority < 5).length;
  const lowCount = scores.filter(s => s.priority > 0 && s.priority < 3).length;
  sumEl.innerHTML = `
    <div class="summary-card"><div class="num">${filled.length}</div><div class="label">Assets Tracked</div></div>
    <div class="summary-card"><div class="num" style="color:var(--danger)">${highCount}</div><div class="label">High Priority</div></div>
    <div class="summary-card"><div class="num" style="color:var(--warning)">${medCount}</div><div class="label">Medium Priority</div></div>
    <div class="summary-card"><div class="num" style="color:var(--success)">${lowCount}</div><div class="label">Lower Priority</div></div>`;

  tbody.innerHTML = filled.map(a => {
    const p = calcPriority(a.idx);
    const n = state.threatNotes[a.idx] || '';
    return `<tr>
      <td class="row-num">${a.idx+1}</td>
      <td class="auto-cell">${esc(a.name)}</td>
      <td class="score-cell">${priorityBadge(p)}</td>
      <td><input type="number" min="1" max="10" value="${n}" data-i="${a.idx}" placeholder="1\u201310"></td>
    </tr>`;
  }).join('');

  mob.innerHTML = filled.map(a => {
    const p = calcPriority(a.idx);
    const n = state.threatNotes[a.idx] || '';
    return `<div class="m-card">
      <div class="m-card-num">${esc(a.name)}</div>
      <div class="m-card-row">
        <div class="m-card-field">
          <div class="m-card-label">Priority</div>
          <div class="m-card-value">${priorityBadge(p)}</div>
        </div>
        <div class="m-card-field">
          <div class="m-card-label">Notes (1\u201310)</div>
          <input type="number" min="1" max="10" value="${n}" data-i="${a.idx}" placeholder="1\u201310">
        </div>
      </div>
    </div>`;
  }).join('');

  const handler = e => {
    const val = e.target.value;
    if (val && (+val < 1 || +val > 10)) return;
    state.threatNotes[e.target.dataset.i] = val;
    saveState();
  };
  bindNumbers(tbody, handler);
  bindNumbers(mob, handler);
}

// ========== RENDER: STEP E ==========
function renderTableE() {
  const tbody = document.getElementById('table-e');
  const mob = document.getElementById('mobile-e');
  const filled = getFilledAssets();
  const none = 'No assets to evaluate.';
  if (!filled.length) {
    tbody.innerHTML = `<tr><td colspan="4" style="padding:24px;text-align:center;color:var(--text-muted)">${none}</td></tr>`;
    mob.innerHTML = emptyMsg(none);
    return;
  }

  tbody.innerHTML = filled.map(a => {
    const p = calcPriority(a.idx); const fix = state.fixScores[a.idx] || '';
    return `<tr>
      <td class="row-num">${a.idx+1}</td>
      <td class="auto-cell">${esc(a.name)}</td>
      <td class="score-cell">${priorityBadge(p)}</td>
      <td><input type="number" min="1" max="10" value="${fix}" data-i="${a.idx}" placeholder="1\u201310"></td>
    </tr>`;
  }).join('');

  mob.innerHTML = filled.map(a => {
    const p = calcPriority(a.idx); const fix = state.fixScores[a.idx] || '';
    return `<div class="m-card">
      <div class="m-card-num">${esc(a.name)}</div>
      <div class="m-card-row">
        <div class="m-card-field">
          <div class="m-card-label">Priority</div>
          <div class="m-card-value">${priorityBadge(p)}</div>
        </div>
        <div class="m-card-field">
          <div class="m-card-label">Ease of Fixing (1\u201310)</div>
          <input type="number" min="1" max="10" value="${fix}" data-i="${a.idx}" placeholder="1\u201310">
        </div>
      </div>
    </div>`;
  }).join('');

  const handler = e => {
    const val = e.target.value;
    if (val && (+val < 1 || +val > 10)) return;
    state.fixScores[e.target.dataset.i] = val;
    saveState();
  };
  bindNumbers(tbody, handler);
  bindNumbers(mob, handler);
}

// ========== RENDER: STEP F ==========
function renderTableF() {
  const tbody = document.getElementById('table-f');
  const mob = document.getElementById('mobile-f');
  const filled = getFilledAssets();
  const none = 'No assets to evaluate.';
  if (!filled.length) {
    tbody.innerHTML = `<tr><td colspan="5" style="padding:24px;text-align:center;color:var(--text-muted)">${none}</td></tr>`;
    mob.innerHTML = emptyMsg(none);
    return;
  }

  tbody.innerHTML = filled.map(a => {
    const p = calcPriority(a.idx); const fix = state.fixScores[a.idx]||''; const rep = state.replaceScores[a.idx]||'';
    return `<tr>
      <td class="row-num">${a.idx+1}</td>
      <td class="auto-cell">${esc(a.name)}</td>
      <td class="score-cell">${priorityBadge(p)}</td>
      <td class="auto-cell ${fix?'':'empty'}">${fix||'\u2014'}</td>
      <td><input type="number" min="1" max="10" value="${rep}" data-i="${a.idx}" placeholder="1\u201310"></td>
    </tr>`;
  }).join('');

  mob.innerHTML = filled.map(a => {
    const p = calcPriority(a.idx); const fix = state.fixScores[a.idx]||''; const rep = state.replaceScores[a.idx]||'';
    return `<div class="m-card">
      <div class="m-card-num">${esc(a.name)}</div>
      <div class="m-card-row">
        <div class="m-card-field">
          <div class="m-card-label">Priority</div>
          <div class="m-card-value">${priorityBadge(p)}</div>
        </div>
        <div class="m-card-field">
          <div class="m-card-label">Fix Score</div>
          <div class="m-card-value">${fix||'\u2014'}</div>
        </div>
      </div>
      <div class="m-card-field">
        <div class="m-card-label">Ease of Replacing (1\u201310)</div>
        <input type="number" min="1" max="10" value="${rep}" data-i="${a.idx}" placeholder="1\u201310">
      </div>
    </div>`;
  }).join('');

  const handler = e => {
    const val = e.target.value;
    if (val && (+val < 1 || +val > 10)) return;
    state.replaceScores[e.target.dataset.i] = val;
    saveState();
  };
  bindNumbers(tbody, handler);
  bindNumbers(mob, handler);
}

// ========== RENDER: STEP G ==========
function renderTableG() {
  const tbody = document.getElementById('table-g');
  const mob = document.getElementById('mobile-g');
  const filled = getFilledAssets();
  const none = 'No assets to evaluate.';
  if (!filled.length) {
    tbody.innerHTML = `<tr><td colspan="6" style="padding:24px;text-align:center;color:var(--text-muted)">${none}</td></tr>`;
    mob.innerHTML = emptyMsg(none);
    return;
  }

  tbody.innerHTML = filled.map(a => {
    const p = calcPriority(a.idx); const fix=state.fixScores[a.idx]||''; const rep=state.replaceScores[a.idx]||''; const rem=state.removeScores[a.idx]||'';
    return `<tr>
      <td class="row-num">${a.idx+1}</td>
      <td class="auto-cell">${esc(a.name)}</td>
      <td class="score-cell">${priorityBadge(p)}</td>
      <td class="auto-cell ${fix?'':'empty'}">${fix||'\u2014'}</td>
      <td class="auto-cell ${rep?'':'empty'}">${rep||'\u2014'}</td>
      <td><input type="number" min="1" max="10" value="${rem}" data-i="${a.idx}" placeholder="1\u201310"></td>
    </tr>`;
  }).join('');

  mob.innerHTML = filled.map(a => {
    const p = calcPriority(a.idx); const fix=state.fixScores[a.idx]||''; const rep=state.replaceScores[a.idx]||''; const rem=state.removeScores[a.idx]||'';
    return `<div class="m-card">
      <div class="m-card-num">${esc(a.name)}</div>
      <div class="m-card-row">
        <div class="m-card-field">
          <div class="m-card-label">Priority</div>
          <div class="m-card-value">${priorityBadge(p)}</div>
        </div>
        <div class="m-card-field">
          <div class="m-card-label">Fix</div>
          <div class="m-card-value">${fix||'\u2014'}</div>
        </div>
        <div class="m-card-field">
          <div class="m-card-label">Replace</div>
          <div class="m-card-value">${rep||'\u2014'}</div>
        </div>
      </div>
      <div class="m-card-field">
        <div class="m-card-label">Ease of Removing (1\u201310)</div>
        <input type="number" min="1" max="10" value="${rem}" data-i="${a.idx}" placeholder="1\u201310">
      </div>
    </div>`;
  }).join('');

  const handler = e => {
    const val = e.target.value;
    if (val && (+val < 1 || +val > 10)) return;
    state.removeScores[e.target.dataset.i] = val;
    saveState();
  };
  bindNumbers(tbody, handler);
  bindNumbers(mob, handler);
}

// ========== RENDER: MITIGATION RESULTS ==========
function renderMitigationResults() {
  const tbody = document.getElementById('table-mitigation');
  const mob = document.getElementById('mobile-mitigation');
  const filled = getFilledAssets();
  const sumEl = document.getElementById('mitigation-summary');

  if (!filled.length) {
    tbody.innerHTML = '<tr><td colspan="7" style="padding:24px;text-align:center;color:var(--text-muted)">No assets to summarize.</td></tr>';
    mob.innerHTML = emptyMsg('No assets to summarize.');
    sumEl.innerHTML = '';
    return;
  }

  let fixBest=0, repBest=0, remBest=0;
  filled.forEach(a => {
    const f=+(state.fixScores[a.idx]||0), r=+(state.replaceScores[a.idx]||0), m=+(state.removeScores[a.idx]||0);
    const mx=Math.max(f,r,m);
    if(mx>0){if(mx===f)fixBest++;else if(mx===r)repBest++;else remBest++;}
  });

  sumEl.innerHTML = `
    <div class="summary-card"><div class="num">${filled.length}</div><div class="label">Total Assets</div></div>
    <div class="summary-card"><div class="num" style="color:#16a34a">${fixBest}</div><div class="label">Best to Fix</div></div>
    <div class="summary-card"><div class="num" style="color:#7c3aed">${repBest}</div><div class="label">Best to Replace</div></div>
    <div class="summary-card"><div class="num" style="color:#d97706">${remBest}</div><div class="label">Best to Remove</div></div>`;

  tbody.innerHTML = filled.map(a => {
    const p=calcPriority(a.idx); const fix=state.fixScores[a.idx]||''; const rep=state.replaceScores[a.idx]||'';
    const rem=state.removeScores[a.idx]||''; const notes=state.mitigationNotes[a.idx]||'';
    return `<tr>
      <td class="row-num">${a.idx+1}</td>
      <td class="auto-cell">${esc(a.name)}</td>
      <td class="score-cell">${priorityBadge(p)}</td>
      <td class="auto-cell ${fix?'':'empty'}">${fix||'\u2014'}</td>
      <td class="auto-cell ${rep?'':'empty'}">${rep||'\u2014'}</td>
      <td class="auto-cell ${rem?'':'empty'}">${rem||'\u2014'}</td>
      <td><input type="text" value="${esc(notes)}" data-i="${a.idx}" placeholder="Your action plan..."></td>
    </tr>`;
  }).join('');

  mob.innerHTML = filled.map(a => {
    const p=calcPriority(a.idx); const fix=state.fixScores[a.idx]||''; const rep=state.replaceScores[a.idx]||'';
    const rem=state.removeScores[a.idx]||''; const notes=state.mitigationNotes[a.idx]||'';
    return `<div class="m-card">
      <div class="m-card-num">${esc(a.name)}</div>
      <div class="m-card-row">
        <div class="m-card-field">
          <div class="m-card-label">Priority</div>
          <div class="m-card-value">${priorityBadge(p)}</div>
        </div>
        <div class="m-card-field">
          <div class="m-card-label">Fix</div>
          <div class="m-card-value">${fix||'\u2014'}</div>
        </div>
        <div class="m-card-field">
          <div class="m-card-label">Replace</div>
          <div class="m-card-value">${rep||'\u2014'}</div>
        </div>
        <div class="m-card-field">
          <div class="m-card-label">Remove</div>
          <div class="m-card-value">${rem||'\u2014'}</div>
        </div>
      </div>
      <div class="m-card-field">
        <div class="m-card-label">Action Plan</div>
        <input type="text" value="${esc(notes)}" data-i="${a.idx}" placeholder="Your action plan...">
      </div>
    </div>`;
  }).join('');

  const handler = e => { state.mitigationNotes[e.target.dataset.i] = e.target.value; saveState(); };
  bindInputs(tbody, handler);
  bindInputs(mob, handler);
}

// ========== RENDER ALL ==========
function renderAll() {
  renderTableA(); renderTableB(); renderTableC(); renderTableD();
  renderThreatResults(); renderTableE(); renderTableF(); renderTableG();
  renderMitigationResults();
}

// ========== ADD ROWS ==========
function addAssetRow() {
  state.assets.push({name: '', desc: ''});
  saveState();
  renderTableA();
  const sel = window.matchMedia('(max-width:768px)').matches ? '#mobile-a' : '#table-a';
  const rows = document.querySelectorAll(`${sel} input[data-field="name"]`);
  const last = rows[rows.length-1];
  if (last) { last.scrollIntoView({behavior:'smooth',block:'center'}); last.focus(); }
}

function addThreatRow() {
  state.threats.push({name: '', desc: ''});
  saveState();
  renderTableB();
  const sel = window.matchMedia('(max-width:768px)').matches ? '#mobile-b' : '#table-b';
  const rows = document.querySelectorAll(`${sel} input[data-field="name"]`);
  const last = rows[rows.length-1];
  if (last) { last.scrollIntoView({behavior:'smooth',block:'center'}); last.focus(); }
}

// ========== EXPORT ==========
function exportCSV() {
  const filled = getFilledAssets();
  if (!filled.length) { alert('No data to export.'); return; }
  let csv = 'Asset Name,Risk Rating,Vulnerability Rating,Priority Score,Ease of Fix,Ease of Replace,Ease of Remove,Action Plan\n';
  filled.forEach(a => {
    const r=state.riskRatings[a.idx]?.rating||''; const v=state.vulnRatings[a.idx]?.rating||'';
    const p=calcPriority(a.idx)??''; const fix=state.fixScores[a.idx]||'';
    const rep=state.replaceScores[a.idx]||''; const rem=state.removeScores[a.idx]||'';
    const notes=(state.mitigationNotes[a.idx]||'').replace(/"/g,'""');
    csv += `"${a.name.replace(/"/g,'""')}","${r}","${v}","${p}","${fix}","${rep}","${rem}","${notes}"\n`;
  });
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'threat_risk_assessment.csv';
  a.click();
}

function printResults() {
  switchTab('mitigation-results');
  setTimeout(() => window.print(), 300);
}

function clearAll() {
  if (!confirm('This will permanently delete all your data. Are you sure?')) return;
  if (!confirm('Really clear everything? This cannot be undone.')) return;
  localStorage.removeItem(STORAGE_KEY);
  state = defaultState();
  renderAll();
}

// ========== INIT ==========
renderAll();
</script>
</body>
</html>
